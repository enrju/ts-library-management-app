<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <script>
        const getObjectOfCookies = () => {
            const arrStr = (decodeURIComponent(document.cookie)).split('; ');

            arrStr.forEach((item, index) => {
                arrStr[index] = item.split('=');
            });

            arrStr.forEach((item, index) => {
                if(index < arrStr.length - 1) {
                    arrStr[index] = '"' + item[0] + '":"' + item[1] + '",';
                } else {
                    arrStr[index] = '"' + item[0] + '":"' + item[1] + '"';
                }
            });

            let str = "{";
            arrStr.forEach(item => {
                str += item;
            });
            str += "}";

            return JSON.parse(str);
        }

        const getUserPanel = async (div) => {
            const res = await fetch('/user-panel.html', {
                method: 'GET',
            });

            const data = await res.text();

            div.innerHTML = data;
        }

        const getUserBooks = async (user_id) => {
            // --- user books ---
            const resUserBooks = await fetch(`/api/users/${user_id}/books`, {
                method: 'GET',
            });

            const dataUserBooks = await resUserBooks.json();

            const panel = document.querySelector(".panel");
            const ulReservedBooks = document.querySelector(".user-books-reserved");
            const ulRentedBooks = document.querySelector(".user-books-rented");
            const ulBooksInLibrary = document.querySelector(".books-in-library");

            if(dataUserBooks.access === false) {
                panel.textContent = "Brak dostępu, lub sesja wygasła"
            } else {
                if(dataUserBooks) {
                    const reservedBooks = dataUserBooks.filter(item => item.state === 'reserved');

                    if(reservedBooks.length > 0) {
                        reservedBooks.forEach((item, index) => {
                            const li = document.createElement("li");

                            li.textContent =
                                String(index + 1) + " | " +
                                item.name_surname + " | " +
                                item.title + " | " +
                                "ważne do: " + item.return_until.substring(0, 10) + " | ";

                            const btn = document.createElement("button");
                            btn.textContent = "Anuluj";
                            btn.addEventListener("click", async e => {
                                e.preventDefault();
                                const id = item.id;
                                const activity = 'cancel';

                                const res = await fetch(`/api/books/${id}/state/${activity}`, {
                                    method: 'PATCH',
                                });

                                const data = await res.json();

                                location.reload();
                            });
                            li.appendChild(btn);

                            ulReservedBooks.appendChild(li);
                        });
                    }

                    const rentedBooks = dataUserBooks.filter(item => item.state === 'rented');

                    if(rentedBooks.length > 0) {
                        rentedBooks.forEach((item, index) => {
                            const li = document.createElement("li");
                            li.textContent =
                                String(index + 1) + " | " +
                                item.name_surname + " | " +
                                item.title + " | " +
                                "oddaj do: " + item.return_until.substring(0, 10) + " |";
                            ulRentedBooks.appendChild(li);
                        });
                    }

                }
            }

            // --- all books ---
            const resAllBooks = await fetch(`/api/books`, {
                method: 'GET',
            });

            const dataAllBooks = await resAllBooks.json();

            if(dataAllBooks.access === false) {
                panel.textContent = "Brak dostępu, lub sesja wygasła"
            } else {
                if(dataAllBooks) {
                    if(dataAllBooks.length > 0) {
                        dataAllBooks.forEach((item, index) => {
                            const li = document.createElement("li");
                            li.textContent =
                                String(index + 1) + " | " +
                                item.name_surname + " | " +
                                item.title + " | " +
                                item.state + " | ";

                            if(item.state === 'available') {
                                const btn = document.createElement("button");
                                btn.textContent = "Rezerwuj";
                                btn.addEventListener("click", async e => {
                                    e.preventDefault();
                                    const id = item.id;
                                    const activity = 'reserve';

                                    const res = await fetch(`/api/books/${id}/state/${activity}`, {
                                        method: 'PATCH',
                                    });

                                    const data = await res.json();

                                    location.reload();
                                });
                                li.appendChild(btn);
                            }

                            ulBooksInLibrary.appendChild(li);
                        });
                    }
                }
            }
        }

        const cookies = getObjectOfCookies();
        const h1 = document.createElement("h1");

        if(cookies.visitor_id) {
            const button = document.createElement("button");
            button.textContent = "Wyloguj";
            button.addEventListener("click", async () => {
                await fetch('/logout', {
                    method: 'POST',
                });

                window.location = '/';
            });
            document.body.appendChild(button);

            h1.textContent = `Witaj: ${cookies.login}`;
            document.body.appendChild(h1);

            const div = document.createElement("div");
            switch(cookies.role) {
                case 'user':
                    getUserPanel(div);
                    getUserBooks(cookies.visitor_id);

                    break;
                case 'admin':
                    div.textContent = "Panel admina";
                    break;
                default:
                    div.textContent = "Nie ma takiego panelu";
            }
            document.body.appendChild(div);
        } else {
            h1.textContent = 'Brak dostępu - musisz być zalogowany';
            document.body.appendChild(h1);
        }


    </script>
</body>
</html>