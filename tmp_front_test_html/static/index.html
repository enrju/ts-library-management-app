<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tmp test HTML</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <script>
        const getObjectOfCookies = () => {
            const arrStr = (decodeURIComponent(document.cookie)).split('; ');

            arrStr.forEach((item, index) => {
                arrStr[index] = item.split('=');
            });

            arrStr.forEach((item, index) => {
                if(index < arrStr.length - 1) {
                    arrStr[index] = '"' + item[0] + '":"' + item[1] + '",';
                } else {
                    arrStr[index] = '"' + item[0] + '":"' + item[1] + '"';
                }
            });

            let str = "{";
            arrStr.forEach(item => {
                str += item;
            });
            str += "}";

            return JSON.parse(str);
        }

        const setHandleRegisterForm = async () => {
            const registerForm = await document.querySelector(".register-form");
            registerForm.addEventListener("submit", async e => {
                e.preventDefault();

                const res = await fetch('http://localhost:3001/user/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: e.target.elements['name'].value,
                        surname: e.target.elements['surname'].value,
                        email: e.target.elements['email'].value,
                        password: e.target.elements['password'].value
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                console.log(data);
            });

            const goToHomeBtn = document.querySelector(".go-to-home");
            goToHomeBtn.addEventListener("click", e => {
                e.preventDefault();

                document.cookie = "isRegisterForm=false";
                document.location.href = "/";
            });
        }
        const getRegisterForm = async (div) => {
            const res = await fetch('/register-form.html', {
                method: 'GET',
            });

            const data = await res.text();

            div.innerHTML = data;

            document.body.appendChild(div);
            await setHandleRegisterForm();
        }

        const setHandleLoginForm = async () => {
            const loginForm = await document.querySelector(".login-form");
            loginForm.addEventListener("submit", async e => {
                e.preventDefault();

                const res = await fetch('http://localhost:3001/auth/login', {
                    method: 'POST',
                    credentials: "include",
                    body: JSON.stringify({
                        email: e.target.elements['email'].value,
                        password: e.target.elements['password'].value
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                console.log(data);
                document.location.href = "/";
            });

            const goToRegisterBtn = document.querySelector(".go-to-register");
            goToRegisterBtn.addEventListener("click", e => {
                e.preventDefault();

                document.cookie = "isRegisterForm=true";
                document.location.href = "/";
            });
        }
        const getLoginForm = async (div) => {
            const res = await fetch('/login-form.html', {
                method: 'GET',
            });

            const data = await res.text();

            div.innerHTML = data;

            document.body.appendChild(div);
            await setHandleLoginForm();
        }


        (async () => {
            const cookies = getObjectOfCookies();
            console.log(cookies);
            const div = document.createElement("div");

            if(cookies.logged) {
                if(cookies.role === 'user') {
                    document.body.innerHTML = "<h1>Panel usera</h1>";
                } else if(cookies.role === 'admin') {
                    document.body.innerHTML = "<h1>Panel admina</h1>";
                }

            } else {
                if(cookies.isRegisterForm === 'false'
                    || !cookies.isRegisterForm) {
                    await getLoginForm(div);
                } else if(cookies.isRegisterForm === 'true') {
                    await getRegisterForm(div);
                }
            }
        })();
    </script>
</body>
</html>